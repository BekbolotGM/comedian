version: '2.2'
networks:
  comedian_comedian:
    external: true

services:

  staging-db:
    image: percona/percona-server:5.7
    restart: on-failure
    command: --max_allowed_packet=32505856                                                                                                                                                     
    environment:                                                                                                                                                                               
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}                                                                                                                                             
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
    networks:
      - comedian_comedian
    volumes:
      - ./percona:/var/lib/mysql:rw
    logging:
      driver: syslog
      options:
        tag: "docker/staging-comedian-db"

  staging-comedian:
    image: registry.gitlab.com/team-monitoring/comedian:staging
    restart: on-failure
    links:
      - staging-db:staging-db
    networks:
      - comedian_comedian
    expose: 
      - 8080
    environment:
      - TZ=Asia/Bishkek
      - DATABASE=${DATABASE}
      - HTTP_BIND_ADDR=0.0.0.0:8080
      - SLACK_CLIENT_ID=${SLACK_CLIENT_ID}
      - SLACK_CLIENT_SECRET=${SLACK_CLIENT_SECRET}
      - COLLECTOR_URL=${COLLECTOR_URL}
      - COLLECTOR_TOKEN=${COLLECTOR_TOKEN}
      - UI_URL=${UI_URL}
      - SLACK_VERIFICATION_TOKEN=${SLACK_VERIFICATION_TOKEN}
      - COMEDIAN_OWNER_SLACK_TEAM_ID=${COMEDIAN_OWNER_SLACK_TEAM_ID}
      - SENTRY_DSN=${SENTRY_DSN}
      - SENTRY_ENVIRONMENT=comedian
      - VIRTUAL_HOST=staging.comedian.maddevs.co
      - LETSENCRYPT_HOST=staging.comedian.maddevs.co
      - LETSENCRYPT_EMAIL=fedorenko.tolik@gmail.com
    depends_on:
      - staging-db
    logging:
      driver: syslog
      options:
        tag: "docker/staging-comedian"