version: '2.2'
networks:
  comedian_comedian:
    external: true

services:

  db:
    container_name: db
    image: percona/percona-server:5.7
    restart: unless-stopped
    command: --max_allowed_packet=32505856
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_USER=comedian
      - MYSQL_PASSWORD=comedian
      - MYSQL_DATABASE=comedian
    networks:
      - comedian_comedian
    # volumes:
    #   - ./percona:/var/lib/mysql:rw
    healthcheck:
     test: "mysql -ucomedian --password=comedian -e 'show databases;' |grep comedian"
     interval: 30s
     timeout: 20s
     retries: 10
#    logging:
#      driver: syslog
#      options:
#        tag: "docker/comedian-mysql"


  golang:
    container_name: golang-test
    image: golang:1.11.4
    restart: always
    # 
    links:
      - db:db
    networks:
      - comedian_comedian
    environment:
      - COMEDIAN_DATABASE=comedian:comedian@tcp(db:3306)/comedian?parseTime=true
      - TESTENVIRONMENT=true
    depends_on:
      - db
    working_dir: /go/src/gitlab.com/team-monitoring/comedian/
    volumes:
      - ./:/go/src/gitlab.com/team-monitoring/comedian/
    command: make migration-ci run_tests
    depends_on:
      db:
          condition: service_healthy
    # logging:
    #   driver: syslog
    #   options:
    #     tag: "docker/comedian-golang"

